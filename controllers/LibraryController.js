const LibraryStore = [
    {
        userId: "ambik@123", library: {

            mytracks: [
                {
                    name: "Sun Le Re all tracks",
                    author: "Papon",
                    image: "/papon.jpg",
                    source: "/yt/CWgpfxiuY8E",
                    track_id: "t1",
                },
                {
                    name: "Kanna Haniyondu all tracks",
                    author: "Raghu Dixit",
                    image: "/lovemocktail.jpg",
                    source: "/yt/7llPi3k-yQs",
                    track_id: "t2",
                }
            ],

            
            frequentlyplayed: [
                {
                    name: "Sun Le Re ambi",
                    author: "Papon",
                    image: "/papon.jpg",
                    source: "/yt/CWgpfxiuY8E",
                    track_id: "t1",
                },
                {
                    name: "freq Kanna Haniyondu ambi",
                    author: "Raghu Dixit",
                    image: "/lovemocktail.jpg",
                    source: "/yt/7llPi3k-yQs",
                    track_id: "t2",
                }
            ]

        },
    },
    {
        userId: "adarsh@123", library: {

            mytracks: [
                     {
                        "image": "https://i.ytimg.com/vi/CB9KCpY_gV4/maxresdefault.jpg",
                        "name": "Kosling & Blackcode & Robbie Rosen - Like Home",
                        "author": "Proximity",
                        "source": "/yt/CB9KCpY_gV4",
                        "track_id": "CB9KCpY_gV4"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/PrgjWmKWzSw/maxresdefault.jpg",
                        "name": "Lewis Capaldi - Someone You Loved (With LÃ¸ve Remix ft. Connor Maynard)",
                        "author": "Arctic Empire",
                        "source": "/yt/PrgjWmKWzSw",
                        "track_id": "PrgjWmKWzSw"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/vsWN_ubLmf4/maxresdefault.jpg",
                        "name": "Said The Sky X ILLENIUM - All I Got X Good Things Falls Apart (Guteren Mashup)",
                        "author": "Arctic Empire",
                        "source": "/yt/vsWN_ubLmf4",
                        "track_id": "vsWN_ubLmf4"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/qBldbhw6Diw/maxresdefault.jpg",
                        "name": "Illenium & Said the Sky - Sad Songs (TCK Remix) [feat. Annika Wells]",
                        "author": "Plaxium",
                        "source": "/yt/qBldbhw6Diw",
                        "track_id": "qBldbhw6Diw"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/M-pjziCK5nU/maxresdefault.jpg",
                        "name": "Into the Dark",
                        "author": "Downplay",
                        "source": "/yt/M-pjziCK5nU",
                        "track_id": "M-pjziCK5nU"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/7BaaovM0_Uc/maxresdefault.jpg",
                        "name": "Waiting On the Sky to Change",
                        "author": "Downplay",
                        "source": "/yt/7BaaovM0_Uc",
                        "track_id": "7BaaovM0_Uc"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/OKWDsTXZDRo/maxresdefault.jpg",
                        "name": "All I Need",
                        "author": "Downplay",
                        "source": "/yt/OKWDsTXZDRo",
                        "track_id": "OKWDsTXZDRo"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/iqQPrDRfQ4I/maxresdefault.jpg",
                        "name": "Best Part Of You Was Me",
                        "author": "Downplay",
                        "source": "/yt/iqQPrDRfQ4I",
                        "track_id": "iqQPrDRfQ4I"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/SGo6fO9v4PM/maxresdefault.jpg",
                        "name": "Fade Away",
                        "author": "Downplay",
                        "source": "/yt/SGo6fO9v4PM",
                        "track_id": "SGo6fO9v4PM"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/0C8NK821J0Q/hqdefault.jpg",
                        "name": "Nurko feat. Dia Frampton - Faith [Lyric Video] (Proximity Release)",
                        "author": "Proximity",
                        "source": "/yt/0C8NK821J0Q",
                        "track_id": "0C8NK821J0Q"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/UbOCUMy4QqE/maxresdefault.jpg",
                        "name": "MitiS - Shattered (Lyrics) feat. RUNN",
                        "author": "MitiS feat. RUNN",
                        "source": "/yt/UbOCUMy4QqE",
                        "track_id": "UbOCUMy4QqE"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/DXrfdy2VKa8/maxresdefault.jpg",
                        "name": "William Black - Deep Blue (Lyrics) Nurko Remix, ft. Monika Santucci",
                        "author": "William Black",
                        "source": "/yt/DXrfdy2VKa8",
                        "track_id": "DXrfdy2VKa8"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/RwISVSxhjTc/maxresdefault.jpg",
                        "name": "A Soulmate Who Wasnt Meant to Be",
                        "author": "Jess Benko",
                        "source": "/yt/RwISVSxhjTc",
                        "track_id": "RwISVSxhjTc"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/NFMZSupxUJ8/maxresdefault.jpg",
                        "name": "Cashmere Cat - FOR YOUR EYES ONLY [acloudyskye bootleg]",
                        "author": "Cashmere Cat",
                        "source": "/yt/NFMZSupxUJ8",
                        "track_id": "NFMZSupxUJ8"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/pqhGjIcMxMw/maxresdefault.jpg",
                        "name": "DROELOE - Sunburn (Official Audio)",
                        "author": "DROELOE",
                        "source": "/yt/pqhGjIcMxMw",
                        "track_id": "pqhGjIcMxMw"
                    },
                     {
                        "image": "https://i.ytimg.com/vi/k2AZZlSDqPc/maxresdefault.jpg",
                        "name": "MitiS Feat. RUNN - Shattered (Culture Code Remix)",
                        "author": "Arctic Empire",
                        "source": "/yt/k2AZZlSDqPc",
                        "track_id": "k2AZZlSDqPc"
                    }
                
            ],

            
            frequentlyplayed: [
                {
                    "image": "https://i.ytimg.com/vi/pqhGjIcMxMw/maxresdefault.jpg",
                    "name": "DROELOE - Sunburn (Official Audio)",
                    "author": "DROELOE",
                    "source": "/yt/pqhGjIcMxMw",
                    "track_id": "pqhGjIcMxMw"
                },
                 {
                    "image": "https://i.ytimg.com/vi/k2AZZlSDqPc/maxresdefault.jpg",
                    "name": "MitiS Feat. RUNN - Shattered (Culture Code Remix)",
                    "author": "Arctic Empire",
                    "source": "/yt/k2AZZlSDqPc",
                    "track_id": "k2AZZlSDqPc"
                }
            ]

        }
    }
];

const Library = require("../models/library.model")
const mongoose = require("mongoose")

const LibraryController = {

    getFrequentlyPlayed: async (userId) => {
        return new Promise((resolve, reject) => {

            Library.find({userId}, (err, result) => {
                if(err) return reject(err);
                
                if(result.length === 0) return reject(err);
                let tracks = result[0].library.mytracks;
                let out = tracks
                .filter(track => track.plays > 0)
                .sort((t1, t2) => (t1.plays > t2.plays) ? -1 : ((t2.plays > t1.plays) ? 1 : 0));
                resolve(out);
                })
            });

    },
    getLibrary: async (userId) => {

        return new Promise((resolve, reject) => {

            Library.find({userId}, (err, result) => {
                if(err) return reject(err);
                if(result.length === 0) return reject(err);
                let _library = result[0];
                    resolve(_library.library);
                })
            });

    },

    addLibrary: async (userId, initialTracks) => {
        return new Promise((resolve, reject) => {
            const temp = { userId, library: { 
                mytracks: [...initialTracks]
             } };
    
             Library.create(temp, function (err, _library) {
                if (err) return reject(err);
                return resolve(_library);
              });
             
        });
    },

    addTrackToLibrary: async (userId, newtrack) => {
        return new Promise((resolve, reject) => {

            Library.find({userId}, (err, result) => {
                if(err) return reject(err);
                let _library = result[0];
                if(_library.library.mytracks.find( track => track.track_id === newtrack.track_id )) {return resolve(true);}
                _library.library = {mytracks: [newtrack,..._library.library.mytracks]};
                _library.save((err, doc) => {
                    if(err) return reject(err);
                    resolve(true);
                })
            });
            
        });
    },
    incrementPlays: async (userId, track_id) => {
        return new Promise((resolve, reject) => {

            Library.find({userId}, (err, result) => {
                if(err) return reject(err);
                let _library = result[0];
                if(_library === undefined) return reject(false);
                const temp = _library.library.mytracks.map(track => {
                    let temp2 = {...track};
                    if(temp2.track_id === track_id) temp2.plays += 1;
                    return temp2;
                })               
                _library.library = {mytracks: temp};
                _library.save((err, doc) => {
                    if(err) return reject(err);
                    resolve(true);
                })
            });
            
        });
    },

    retrieveAll: async () => {
        return new Promise((resolve, reject) => {
            Library.find({}, (err, libs) => {
                if(err) return reject(err);
                resolve(libs);
            });

        });
    }

};
global.Library = Library;
module.exports = { ...LibraryController };